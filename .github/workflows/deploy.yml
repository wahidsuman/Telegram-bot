name: Deploy Cloudflare Worker

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Wrangler publish
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # Optional if not in wrangler.toml
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy --non-interactive

      - name: Set Telegram webhook
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          WORKER_NAME: telegram-mcq-bot
          WORKERS_SUBDOMAIN: ${{ secrets.WORKERS_SUBDOMAIN }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${WEBHOOK_SECRET}" ] || [ -z "${WORKERS_SUBDOMAIN}" ]; then
            echo "Skipping webhook setup due to missing secrets." && exit 0
          fi
          WEBHOOK_URL="https://${WORKER_NAME}.${WORKERS_SUBDOMAIN}.workers.dev/webhook"
          curl -sS -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook" \
            -H 'Content-Type: application/json' \
            -d "{\"url\":\"${WEBHOOK_URL}\",\"secret_token\":\"${WEBHOOK_SECRET}\"}"
          echo "Webhook set to ${WEBHOOK_URL}"

